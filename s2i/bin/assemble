#!/bin/bash -e
#
# S2I assemble script for the 's2i-maven-java' image.
# The 'assemble' script builds your application source so that it is ready to run.
#
# For more information refer to the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

set -e

shopt -u dotglob

if [[ "$1" == "-h" ]]; then
	exec /usr/libexec/s2i/usage
fi

if [ ! -f /tmp/src/pom.xml ]; then
  echo "FATAL - No pom.xml found"
  exit 1
fi



if [ -d /tmp/artifacts/.m2 ]; then
  echo "---> Restoring build artifacts..."
  mv /tmp/artifacts/.m2 "$HOME"/
fi

echo "---> INSTALANDO CODIGO FUENTE..." 
mkdir /opt/src
mv /tmp/src/.git /opt/src/
cp -Rf /tmp/src/* /opt/src/




if [ -z "$TAG_VERSION" ]; then
  echo "NO VARIABLE TAG_VERSION ENCONTRADA USANDO latest"
else

echo "VARIABLE TAG_VERSION ENCONTRADA USANDO: $TAG_VERSION"
echo $TAG_VERSION > /opt/version
fi



if [ -z "$NEXUS_MIRROR_URL" ]; then
echo "NO NEXUS_MIRROR_URL ENCONTRADO"
else
echo "NEXUS_MIRROR_URL ENCONTRADO - AGREGANDO REPOSITORIO"

if [ ! -d /home/s2i/.m2 ]; then
  mkdir /home/s2i/.m2
  touch /home/s2i/.m2/settings.xml
fi

cat << EOF > /home/s2i/.m2/settings.xml

<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">

  <mirrors>
    <mirror>
      <id>central</id>
      <name>central</name>
      <url>$NEXUS_MIRROR_URL</url>
      <mirrorOf>*</mirrorOf>
    </mirror>
  </mirrors>


</settings>

EOF

fi



if [ -z "$EXTRA_REPO" ]; then
echo "NO EXTRA_REPO ENCONTRADO"
else
echo "EXTRA_REPO ENCONTRADO - COMPILANDO REPOSITORIO ADICIONAL.."
mkdir /opt/extra_repo && cd /opt/extra_repo && \
git clone $EXTRA_REPO . && \
mvn clean install -Dfile.encoding=UTF-8 -DskipTests=true ${MVN_OPTS} && \
echo "COMPILADO EXTRA_REPO FINALIZADO - LIMPIANDO DIRECTORIOS.." && rm -rf /opt/extra_repo 
fi
echo "---> COMPILANDO CODIGO FUENTE..."
cd /opt/src && mvn clean package -Dfile.encoding=UTF-8 -DskipTests=true ${MVN_OPTS} && \
echo "---> COPIANDO APLICACION GENERADA AL DIRECTORIO DE DEPLOY..."
find . -name '*-thorntail.jar' | xargs cp -t . || find . -name '*-swarm.jar' | xargs cp -t . && mv *.jar /opt/app-root/app.jar && echo "APP INSTALADA!" && \
rm -rf /opt/src /tmp/src /home/s2i/.m2
